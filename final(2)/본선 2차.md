# 본선 2차 — RoadRunner 자율주행 시뮬레이션 (final2)

> `Third_Impact_final2.mlx`(런처)와 `Third_Impact_final2.slx`(RoadRunner Behavior 제어 모델)를 **세세하게** 설명하고, 어떻게 하면 실행 할 수 있는지 정리했습니다!

---
## 실행 영상
https://github.com/user-attachments/assets/e5bf20b4-b53e-46cf-94a6-a1721da3aa57

## 구현 사항
**RoadRunner에서 차선이탈 방지 자율주행 + 앞에 자동차 있을 경우 차선 변경 구현**

## 구글 드라이브 파일 링크
https://drive.google.com/drive/folders/1MZrk5KygLa-TrtS4h8m7FX8dpd-CAfQZ?usp=sharing

## 1) Live Script (`Third_Impact_final2.mlx`) — 코드 라인별 설명

```matlab
clear all
clc
close all


load('map.mat')

global L Ld0 x_ref y_ref  x_ref2 y_ref2 presentLane count 
count = 0;
presentLane = 0;
L = 15;
Ld0 = 5;

x = trajectory_inside(:,1)';
y = trajectory_inside(:,2)';
t = [0, cumsum(sqrt(diff(x).^2 + diff(y).^2))]; 
t = t / t(end);
tq = linspace(0, 1, length(x)*10);
x_ref = interp1(t, x, tq, 'spline');
y_ref = interp1(t, y, tq, 'spline');

x2 = trajectory_outside(:,1)';
y2 = trajectory_outside(:,2)';
t2 = [0, cumsum(sqrt(diff(x2).^2 + diff(y2).^2))]; 
t2 = t2 / t2(end);
tq2 = linspace(0, 1, length(x2)*10);
x_ref2 = interp1(t2, x2, tq2, 'spline');
y_ref2 = interp1(t2, y2, tq2, 'spline');

rrAppPath = "C:\Program Files\RoadRunner R2025a\bin\win64";
rrProjectPath = "C:\Matlab_RoadRunner_Scenario\competition";

s = settings;
s.roadrunner.application.InstallationFolder.TemporaryValue = rrAppPath;
sceneName ='competition';
scenarioName = "competition";
% 로드러너에서의 behavior 이름
behaviorName = "behav";

rrApp = roadrunner(rrProjectPath);

openScene(rrApp, sceneName); % scene 파일명

openScenario(rrApp, scenarioName); % Scenario 파일명

rrSim = createSimulation(rrApp);
global Ts 
Ts = 0.01;
set(rrSim,StepSize=Ts)
open_system("Third_Impact_final2")
helperSLHighwayLaneFollowingWithRRSetup(rrApp,rrSim,scenarioFileName=scenarioName, behaviorName = behaviorName)
set_param("Third_Impact_final2",SimulationCommand="update")

presentLane = startLane;

set(rrSim, 'SimulationCommand','Start');
```

### 라인별 설명
  1. `clear all`
    - 워크스페이스 초기화.
  2. `clc`
    - 커맨드 윈도우 정리.
  3. `close all`
    - 열린 Figure 창 모두 닫기.
  6. `load('map.mat')`
    - 시뮬레이션에 필요한 데이터/맵 로드.
  8. `global L Ld0 x_ref y_ref  x_ref2 y_ref2 presentLane count`
    - 전역 변수 선언(제어 파라미터/참조 궤적 등).
 16. `t = [0, cumsum(sqrt(diff(x).^2 + diff(y).^2))];`
    - 아크길이/누적 거리 계산.
 18. `tq = linspace(0, 1, length(x)*10);`
    - 균일한 파라미터화/샘플 포인트 생성.
 19. `x_ref = interp1(t, x, tq, 'spline');`
    - 참조 경로를 보간하여 고해상도 궤적 생성.
 20. `y_ref = interp1(t, y, tq, 'spline');`
    - 참조 경로를 보간하여 고해상도 궤적 생성.
 24. `t2 = [0, cumsum(sqrt(diff(x2).^2 + diff(y2).^2))];`
    - 아크길이/누적 거리 계산.
 26. `tq2 = linspace(0, 1, length(x2)*10);`
    - 균일한 파라미터화/샘플 포인트 생성.
 27. `x_ref2 = interp1(t2, x2, tq2, 'spline');`
    - 참조 경로를 보간하여 고해상도 궤적 생성.
 28. `y_ref2 = interp1(t2, y2, tq2, 'spline');`
    - 참조 경로를 보간하여 고해상도 궤적 생성.
 30. `rrAppPath = "C:\Program Files\RoadRunner R2025a\bin\win64";`
    - — MATLAB 경로 설정
 31. `rrProjectPath = "C:\Matlab_RoadRunner_Scenario\competition";`
    - — Project파일 경로 설정
 40. `rrApp = roadrunner(rrProjectPath);`
    - RoadRunner 인스턴스 생성 및 연결.
 42. `openScene(rrApp, sceneName); % scene 파일명`
    - 지정한 Scene 열기.
 44. `openScenario(rrApp, scenarioName); % Scenario 파일명`
    - 지정한 Scenario 열기.
 46. `rrSim = createSimulation(rrApp);`
    - RoadRunner 시뮬레이션 컨텍스트 생성.
 47. `global Ts`
    - 전역 변수 선언(제어 파라미터/참조 궤적 등).
 48. `Ts = 0.01;`
    - — 샘플링 시간 설정
 49. `set(rrSim,StepSize=Ts)`
    - RoadRunner 시뮬레이션 스텝시간을 Ts로 설정.
 50. `open_system("Third_Impact_final2")`
    - Behavior Simulink 모델 열기.
 51. `helperSLHighwayLaneFollowingWithRRSetup(rrApp,rrSim,scenarioFileName=scenarioName, behaviorName = behaviorName)`
    - RR-Behavior 매핑/센서 경로 설정 헬퍼 호출.
 52. `set_param("Third_Impact_final2",SimulationCommand="update")`
    - 모델 업데이트(변경사항 적용).
 56. `set(rrSim, 'SimulationCommand','Start');`
    - RoadRunner 시뮬레이션 시작.
 62. `%set(rrSim, 'SimulationCommand', 'Start')`
    - RoadRunner 시뮬레이션 시작.
---

## 2) Simulink Behavior (`Third_Impact_final2.slx`) — Top-Level 구조

### 2.1 블록 인벤토리
| SID | Block Name | BlockType | MaskType |
| --- | --- | --- | --- |
| 4947 | Actor Pose Reader | Reference |  |
| 4244 | Digital Clock | DigitalClock |  |
| 4946 | Ego Pose Reader | Reference |  |
| 4949 | Ego Pose Writer | Reference |  |
| 4437 | Goto1 | Goto |  |
| 5196 | Interpreted MATLAB
Function | MATLABFcn |  |
| 5197 | Mux | Mux |  |
| 5199 | Mux1 | Mux |  |
| 4416 | Pack Actor Poses | MATLABSystem |  |
| 4321 | Pack Ego Pose | SubSystem |  |
| 4268 | Queue | Queue |  |
| 4271 | Receive | Receive |  |
| 4948 | RoadRunner Scenario | Reference |  |
| 4274 | Send | Send |  |
| 4896 | Sensors and Vehicles | SubSystem |  |
| 5098 | Vehicle Dynamics | SubSystem |  |
| 5114 | speed | SubSystem |  |
| 5143 | steering | SubSystem |  |

### 2.2 신호 연결(From → To)
| From (block:port) | To (block:port) |
| --- | --- |
| Ego Pose Reader:1 | Receive:1 |
| Digital Clock:1 |  |
| Send:1 | Ego Pose Writer:1 |
| Vehicle Dynamics:1 | Pack Ego Pose:1 |
| Receive:1 | Sensors and Vehicles:1 |
| Actor Pose Reader:1 | Queue:1 |
| Pack Ego Pose:1 | Send:1 |
| Queue:1 | Pack Actor Poses:2 |
| Pack Actor Poses:1 | Sensors and Vehicles:2 |
| Vehicle Dynamics:2 |  |
| speed:1 | Vehicle Dynamics:2 |
| steering:1 |  |
| Sensors and Vehicles:1 |  |
| Sensors and Vehicles:2 | Mux:2 |
| Sensors and Vehicles:3 | Mux:3 |
| Sensors and Vehicles:4 | Mux:4 |
| Sensors and Vehicles:5 | Mux:5 |
| Mux:1 | Interpreted MATLAB
Function:1 |
| Mux1:1 | Mux:1 |
---
## 3) 실행 방법
   1. `Third_Impact_final2.mlx`에 알맞은 프로젝트 경로를 입력해준뒤
   2. `Third_Impact_final2.slx`을 roadrunner behavior에 넣어 줍니다.
   3. `Third_Impact_final2.mlx`파일을 전체 실행해줍니다!.
---
