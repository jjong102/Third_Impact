# 본선 1차 — RoadRunner 자율주행 시뮬레이션 설명서

> `Third_Impact_final1.mlx`(런처)와 `Third_Impact_final1.slx`(RoadRunner Behavior 제어 모델)를 **세세하게** 설명하고, 어떻게 하면 실행 할 수 있는지 정리했습니다!

---
## 실행 영상
https://github.com/user-attachments/assets/3ba1e194-50ca-45f3-b549-844e0867186e

## 구글 드라이브 파일 링크
https://drive.google.com/drive/folders/12aTJbMc5u288ltzhXlnYqVNs9V3YMvPx?usp=sharing

## 1) `Third_Impact_final1.mlx` — 코드 설명

```matlab
clear all
clc
close all

load('map.mat')

global L Ld0 x_ref y_ref ss
L = 10;
Ld0 = 5;

x = trajectory_inside(:,1)';
y = trajectory_inside(:,2)';
t = [0, cumsum(sqrt(diff(x).^2 + diff(y).^2))]; 
t = t / t(end);
tq = linspace(0, 1, length(x)*10);
x_ref = interp1(t, x, tq, 'spline');
y_ref = interp1(t, y, tq, 'spline');

dx = diff(x_ref); 
dy = diff(y_ref);
ss  = [0, cumsum(hypot(dx,dy))];     

% 수정 부분
rrAppPath = "C:\Program Files\RoadRunner R2025a\bin\win64";
rrProjectPath = "C:\Matlab_RoadRunner_Scenario\competition";

s = settings;
s.roadrunner.application.InstallationFolder.TemporaryValue = rrAppPath;
sceneName ='competition';
scenarioName = "competition";
% 로드러너에서 차량에 설정된 behavior 이름
behaviorName = "PURE";

rrApp = roadrunner(rrProjectPath);

openScene(rrApp, sceneName); % scene 파일명

openScenario(rrApp, scenarioName); % Scenario 파일명

rrSim = createSimulation(rrApp);
Ts = 0.01;
set(rrSim,StepSize=Ts)
open_system("Third_Impact_final1")
helperSLHighwayLaneFollowingWithRRSetup(rrApp,rrSim,scenarioFileName=scenarioName, behaviorName = behaviorName)
set_param("Third_Impact_final1",SimulationCommand="update")

set(rrSim, 'SimulationCommand','Start');
```

### 라인별 설명
  1. `clear all`
    - 워크스페이스 변수 초기화.
  2. `clc`
    - 커맨드 윈도우 정리.
  3. `close all`
    - 열린 Figure(플롯) 창 모두 닫기.
  5. `load('map.mat')`
    - `map.mat`에서 맵/경로 데이터 로드(예: 웨이포인트, trajectory).
  7. `global L Ld0 x_ref y_ref ss`
    - 제어기 및 참조 궤적에 필요한 전역 변수 선언.
  8. `L = 10;`
    - 차량 휠베이스 또는 제어 관련 길이 파라미터 설정 예시.
  9. `x = trajectory_inside(:,1)';`
    - 맵에서 궤적의 x좌표 추출.
 12. `y = trajectory_inside(:,2)';`
    - 맵에서 궤적의 y좌표 추출.
 13. `t = [0, cumsum(sqrt(diff(x).^2 + diff(y).^2))];`
    - 이동 거리 누적합으로 경로 아크길이를 계산.
 14. `t = t / t(end);`
    - t를 0~1로 정규화.
 15. `tq = linspace(0, 1, length(x)*10);`
    - 보간 샘플 수 확장(경로 포인트 고밀도화).
 16. `x_ref = interp1(t, x, tq, 'spline');`
    - x 좌표를 스플라인으로 보간한 참조 경로.
 17. `y_ref = interp1(t, y, tq, 'spline');`
    - y 좌표를 스플라인으로 보간한 참조 경로.
 24. `rrAppPath = "C:\Program Files\RoadRunner R2025a\bin\win64";`
    - RoadRunner 설치 경로 지정 (사용자 환경에 맞게 변경 필요).
 25. `rrProjectPath = "C:\Matlab_RoadRunner_Scenario\competition";`
    - RoadRunner 프로젝트 루트 경로.
 28. `s.roadrunner.application.InstallationFolder.TemporaryValue = rrAppPath;`
    - RoadRunner 설치 경로 지정 (사용자 환경에 맞게 변경 필요).
 29. `sceneName ='competition';`
    - 신 파일 이름을 작성합니다.
 30. `scenarioName = "competition";`
    - 해당 시나리오 파일 이름을 작성합니다.
 32. `behaviorName = "PURE";`
    - RoadRunner Behavior(행동 모델) 이름(매핑용).
 34. `rrApp = roadrunner(rrProjectPath);`
    - RoadRunner 프로젝트 루트 경로.
 36. `openScene(rrApp, sceneName); % scene 파일명`
    - 지정한 Scene 파일을 RoadRunner에서 오픈.
 38. `openScenario(rrApp, scenarioName); % Scenario 파일명`
    - 지정한 Scenario 파일을 RoadRunner에서 오픈.
 42. `set(rrSim,StepSize=Ts)`
    - RoadRunner 시뮬레이션 스텝 사이즈를 Simulink `Ts`와 일치시킴.
 43. `open_system("Third_Impact_final1")`
    - Simulink Behavior 모델 열기.
 44. `helperSLHighwayLaneFollowingWithRRSetup(rrApp,rrSim,scenarioFileName=scenarioName, behaviorName = behaviorName)`
    - RoadRunner Behavior(행동 모델) 이름(매핑용).
 45. `set_param("Third_Impact_final1",SimulationCommand="update")`
    - 블록/파라미터 변경사항 반영(모델 업데이트).
 47. `set(rrSim, 'SimulationCommand','Start');`
    - RoadRunner 시뮬레이션 시작.
---

## 2) Simulink Behavior (`Third_Impact_final1.slx`) — 블록 구조 & 신호 연결

### 2.1 블록 인벤토리 (Top Level)
아래 표는 **Top-Level** 모델의 주요 블록 목록입니다.

| SID | Block Name | BlockType | MaskType |
| --- | --- | --- | --- |
| 4947 | Actor Pose Reader | Reference |  |
| 5095 | Demux | Demux |  |
| 4244 | Digital Clock | DigitalClock |  |
| 4946 | Ego Pose Reader | Reference |  |
| 4949 | Ego Pose Writer | Reference |  |
| 4437 | Goto1 | Goto |  |
| 5075 | Interpreted MATLAB
Function | MATLABFcn |  |
| 5076 | Interpreted MATLAB
Function1 | MATLABFcn |  |
| 5118 | Interpreted MATLAB
Function2 | MATLABFcn |  |
| 5077 | Mux | Mux |  |
| 4416 | Pack Actor Poses | MATLABSystem |  |
| 4321 | Pack Ego Pose | SubSystem |  |
| 4268 | Queue | Queue |  |
| 4271 | Receive | Receive |  |
| 4948 | RoadRunner Scenario | Reference |  |
| 4274 | Send | Send |  |
| 4896 | Sensors and Vehicles | SubSystem |  |
| 5114 | Subsystem | SubSystem |  |
| 4304 | Terminator2 | Terminator |  |
| 5096 | To Workspace | ToWorkspace |  |
| 5098 | Vehicle Dynamics | SubSystem |  |

>블록 설명
> - **Ego Pose Reader/Writer, Actor Pose Reader**: RoadRunner와의 포즈 입/출력 인터페이스 블록
> - **Vehicle Dynamics**: 차량 동역학 계산(속도/가속/조향 반영)
> - **Interpreted MATLAB Function(×3)**: 사용자 정의 로직(예: 경로 추종, dead-reckoning, 신호 전처리) 삽입
> - **Pack Ego/Actor Poses, Queue, Send/Receive**: RR-Behavior 신호 패킹/큐잉/송수신
> - **Sensors and Vehicles**: RoadRunner 시뮬레이션 장면과 Simulink 사이의 센서/액터 신호 집약 지점
> - **To Workspace**: 후처리/검증용 로깅

### 2.2 신호 연결(From→To)
Top-Level에서 확인된 주요 라인 연결은 다음과 같습니다.

| From (block:port) | To (block:port) |
| --- | --- |
| Ego Pose Reader:1 | Receive:1 |
| Digital Clock:1 |  |
| Send:1 | Ego Pose Writer:1 |
| Vehicle Dynamics:3 | Terminator2:1 |
| Vehicle Dynamics:1 | Pack Ego Pose:1 |
| Receive:1 | Sensors and Vehicles:1 |
| Actor Pose Reader:1 | Queue:1 |
| Pack Ego Pose:1 | Send:1 |
| Queue:1 | Pack Actor Poses:2 |
| Pack Actor Poses:1 | Sensors and Vehicles:2 |
| Sensors and Vehicles:1 |  |
| Interpreted MATLAB
Function:1 | Mux:2 |
| Mux:1 | Interpreted MATLAB
Function1:1 |
| Vehicle Dynamics:2 |  |
| Demux:1 | Interpreted MATLAB
Function:1 |
| Subsystem:1 | Vehicle Dynamics:2 |
| Interpreted MATLAB
Function1:1 |  |

> 해석
> - `Ego Pose Reader:1 → Receive:1` : RR의 에고 차량 포즈를 Behavior 쪽 Receive 입력으로 공급
> - `Pack Ego Pose:1 → Send:1 → Ego Pose Writer:1` : Behavior에서 생성한 에고 포즈/명령을 패킹→송신→RR에 기록
> - `Vehicle Dynamics` 블록 출력 일부가 Terminator로 연결: 미사용 디버그/보조 출력 차단


---

## 3) 실행 방법
   1. `Third_Impact_final1.mlx`에 알맞은 프로젝트 경로를 입력해준뒤
   2. `Third_Impact_final1.slx`을 roadrunner behavior에 넣어 줍니다.
   3. `Third_Impact_final1.mlx`파일을 전체 실행해줍니다!

---
